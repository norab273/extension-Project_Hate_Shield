let dictionaryBadWords = new Map();
dictionaryBadWords.set("allumeuse", "ðŸŒ¸");
dictionaryBadWords.set("babtou", "ðŸŒ¸");
dictionaryBadWords.set("bamboula", "ðŸŒ¸");
dictionaryBadWords.set("bÃ¢tard", "ðŸŒ¸");
dictionaryBadWords.set("bÃ¢tard noir", "ðŸŒ¸");
dictionaryBadWords.set("bÃ©casse", "ðŸŒ¸");
dictionaryBadWords.set("bimbo", "ðŸŒ¸");
dictionaryBadWords.set("blondasse", "ðŸŒ¸");
dictionaryBadWords.set("bobonne", "ðŸŒ¸");
dictionaryBadWords.set("bonasse", "ðŸŒ¸");
dictionaryBadWords.set("boniche", "ðŸŒ¸");
dictionaryBadWords.set("boucaque", "ðŸŒ¸");
dictionaryBadWords.set("bouffeur de chiens", "ðŸŒ¸");
dictionaryBadWords.set("bouffeuse de chiens", "ðŸŒ¸");
dictionaryBadWords.set("bougnoule", "ðŸŒ¸");
dictionaryBadWords.set("cagole", "ðŸŒ¸");
dictionaryBadWords.set("catin", "ðŸŒ¸");
dictionaryBadWords.set("chagnasse", "ðŸŒ¸");
dictionaryBadWords.set("chaudasse", "ðŸŒ¸");
dictionaryBadWords.set("chinetoque", "ðŸŒ¸");
dictionaryBadWords.set("ching chong", "ðŸŒ¸");
dictionaryBadWords.set("connard", "ðŸŒ¸");
dictionaryBadWords.set("connasse", "ðŸŒ¸");
dictionaryBadWords.set("crouille", "ðŸŒ¸");
dictionaryBadWords.set("dÃ©bile", "ðŸŒ¸");
dictionaryBadWords.set("donzelle", "ðŸŒ¸");
dictionaryBadWords.set("enculÃ©", "ðŸŒ¸");
dictionaryBadWords.set("enculer", "ðŸŒ¸");
dictionaryBadWords.set("fais pas ta meuf", "ðŸŒ¸");
dictionaryBadWords.set("fatma", "ðŸŒ¸");
dictionaryBadWords.set("FDP", "ðŸŒ¸");
dictionaryBadWords.set("fille de joie", "ðŸŒ¸");
dictionaryBadWords.set("fille facile", "ðŸŒ¸");
dictionaryBadWords.set("fille lÃ©gÃ¨re", "ðŸŒ¸");
dictionaryBadWords.set("fils de pute", "ðŸŒ¸");
dictionaryBadWords.set("fils de putain", "ðŸŒ¸");
dictionaryBadWords.set("fiotte", "ðŸŒ¸");
dictionaryBadWords.set("garce", "ðŸŒ¸");
dictionaryBadWords.set("gogole", "ðŸŒ¸");
dictionaryBadWords.set("gonzesse", "ðŸŒ¸");
dictionaryBadWords.set("gouine", "ðŸŒ¸");
dictionaryBadWords.set("grognasse", "ðŸŒ¸");
dictionaryBadWords.set("grosse vache", "ðŸŒ¸");
dictionaryBadWords.set("hystÃ©rique", "ðŸŒ¸");
dictionaryBadWords.set("macaque", "ðŸŒ¸");
dictionaryBadWords.set("mal-baisÃ©", "ðŸŒ¸");
dictionaryBadWords.set("mal-baisÃ©e", "ðŸŒ¸");
dictionaryBadWords.set("mÃ©gÃ¨re", "ðŸŒ¸");
dictionaryBadWords.set("nÃ¨gre", "ðŸŒ¸");
dictionaryBadWords.set("nÃ©gresse", "ðŸŒ¸");
dictionaryBadWords.set("nÃ©gro", "ðŸŒ¸");
dictionaryBadWords.set("niakouÃ©", "ðŸŒ¸");
dictionaryBadWords.set("niakouÃ©e", "ðŸŒ¸");
dictionaryBadWords.set("niaquÃ©", "ðŸŒ¸");
dictionaryBadWords.set("niaquÃ©e", "ðŸŒ¸");
dictionaryBadWords.set("niaquouÃ©", "ðŸŒ¸");
dictionaryBadWords.set("niaquouÃ©e", "ðŸŒ¸");
dictionaryBadWords.set("nigga", "ðŸŒ¸");
dictionaryBadWords.set("nigger", "ðŸŒ¸");
dictionaryBadWords.set("nique", "ðŸŒ¸");
dictionaryBadWords.set("nique ta mÃ¨re", "ðŸŒ¸");
dictionaryBadWords.set("peau rouge", "ðŸŒ¸");
dictionaryBadWords.set("pÃ©dale", "ðŸŒ¸");
dictionaryBadWords.set("pÃ©dÃ©", "ðŸŒ¸");
dictionaryBadWords.set("PD", "ðŸŒ¸");
dictionaryBadWords.set("pÃ©tasse", "ðŸŒ¸");
dictionaryBadWords.set("pimbÃªche", "ðŸŒ¸");
dictionaryBadWords.set("pouffiasse", "ðŸŒ¸");
dictionaryBadWords.set("pouffiasse", "ðŸŒ¸");
dictionaryBadWords.set("putain", "ðŸŒ¸");
dictionaryBadWords.set("putasse", "ðŸŒ¸");
dictionaryBadWords.set("pute", "ðŸŒ¸");
dictionaryBadWords.set("racoleuse", "ðŸŒ¸");
dictionaryBadWords.set("retourne dans ton pays", "ðŸŒ¸");
dictionaryBadWords.set("sale arabe", "ðŸŒ¸");
dictionaryBadWords.set("sale bridÃ©", "ðŸŒ¸");
dictionaryBadWords.set("sale juif", "ðŸŒ¸");
dictionaryBadWords.set("sale juive", "ðŸŒ¸");
dictionaryBadWords.set("sale musulman", "ðŸŒ¸");
dictionaryBadWords.set("sale musulmane", "ðŸŒ¸");
dictionaryBadWords.set("sale noir", "ðŸŒ¸");
dictionaryBadWords.set("sale trans", "ðŸŒ¸");
dictionaryBadWords.set("salope", "ðŸŒ¸");
dictionaryBadWords.set("singe noir", "ðŸŒ¸");
dictionaryBadWords.set("tafiole", "ðŸŒ¸");
dictionaryBadWords.set("tantouze", "ðŸŒ¸");
dictionaryBadWords.set("tapette", "ðŸŒ¸");
dictionaryBadWords.set("tapineuse", "ðŸŒ¸");
dictionaryBadWords.set("tarlouse", "ðŸŒ¸");
dictionaryBadWords.set("tchoin", "ðŸŒ¸");
dictionaryBadWords.set("teubÃ©", "ðŸŒ¸");
dictionaryBadWords.set("toubab", "ðŸŒ¸");
dictionaryBadWords.set("trainÃ©e", "ðŸŒ¸");
dictionaryBadWords.set("travelo", "ðŸŒ¸");
dictionaryBadWords.set("va manger du chien", "ðŸŒ¸");
dictionaryBadWords.set("vieille-peau", "ðŸŒ¸");
dictionaryBadWords.set("youpin", "ðŸŒ¸");
dictionaryBadWords.set("youpine", "ðŸŒ¸");

browser.runtime.onMessage.addListener(addNew);

addNew();
function addNew() {
  console.log("âš ï¸");
  var gettingWords = browser.storage.local.get(null);
  console.log("â€¼ï¸");
  gettingWords.then((result) => {
    // var words = getWords(result["userWords"]);
    console.log("ðŸ’ ");
    var words = JSON.parse(result["userWords"]);
    console.log("words âœ…: " + words);
    for (let word of words) {
      addToDictionary(word);
      console.log("word â“: " + word);
    }
    replaceText(document.body);

    getActiveTab()
      .then((tabs) => {
        console.log(tabs);
        console.log(tabs.find((tab) => tab.active).id);
        currentTabId = tabs.find((tab) => tab.active).id;
        replaceText(document.body);
      })
      .catch((err) => console.log(err));
  }, onError);
}

//function that replaces letters with accents
String.prototype.sansAccents = function () {
  return this.replace(/[Ã¹Ã»Ã¼]/g, "u")
    .replace(/[Ã®Ã¯]/g, "i")
    .replace(/[Ã Ã¢Ã¤]/g, "a")
    .replace(/[Ã´Ã¶]/g, "o")
    .replace(/[Ã©Ã¨ÃªÃ«]/g, "e")
    .replace(/Ã§/g, "c");
};

let regexBadWords = new Map();

for (let element of dictionaryBadWords.keys()) {
  regexBadWords.set(
    element,
    new RegExp("\\b" + element.sansAccents() + "\\b", "gi")
  );
}

//gets active tab
function getActiveTab() {
  return browser.tabs.query({ active: true, currentWindow: true });
}

// The user can add new words to dictionnary

function addToDictionary(word) {
  if (word) {
    dictionaryBadWords.set(word, "ðŸŒ¸");
    regexBadWords.set(word, new RegExp("\\b" + word + "\\b", "gi"));
  }
}

function replaceText(node) {
  if (node.nodeType === Node.TEXT_NODE) {
    if (node.parentNode && node.parentNode.nodeName === "TEXTAREA") {
      return;
    }

    let content = node.textContent;
    for (let [element, emoji] of dictionaryBadWords) {
      let regex = regexBadWords.get(element);

      if (!document.getElementById("badWordsList")) {
        content = content.sansAccents().replace(regex, emoji);
      }
    }

    node.textContent = content;
  } else {
    for (let i = 0; i < node.childNodes.length; i++) {
      replaceText(node.childNodes[i]);
    }
  }
}

replaceText(document.body);

const observer = new MutationObserver((mutations) => {
  mutations.forEach((mutation) => {
    if (mutation.addedNodes && mutation.addedNodes.length > 0) {
      for (let i = 0; i < mutation.addedNodes.length; i++) {
        const newNode = mutation.addedNodes[i];
        replaceText(newNode);
      }
    }
  });
});
observer.observe(document.body, {
  childList: true,
  subtree: true,
});
