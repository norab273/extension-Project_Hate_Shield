let dictionaryBadWords = new Map();
dictionaryBadWords.set("allumeuse", "üå∏");
dictionaryBadWords.set("babtou", "üå∏");
dictionaryBadWords.set("bamboula", "üå∏");
dictionaryBadWords.set("b√¢tard", "üå∏");
dictionaryBadWords.set("b√¢tard noir", "üå∏");
dictionaryBadWords.set("b√©casse", "üå∏");
dictionaryBadWords.set("bimbo", "üå∏");
dictionaryBadWords.set("blondasse", "üå∏");
dictionaryBadWords.set("bobonne", "üå∏");
dictionaryBadWords.set("bonasse", "üå∏");
dictionaryBadWords.set("boniche", "üå∏");
dictionaryBadWords.set("boucaque", "üå∏");
dictionaryBadWords.set("bouffeur de chiens", "üå∏");
dictionaryBadWords.set("bouffeuse de chiens", "üå∏");
dictionaryBadWords.set("bougnoule", "üå∏");
dictionaryBadWords.set("cagole", "üå∏");
dictionaryBadWords.set("catin", "üå∏");
dictionaryBadWords.set("chagnasse", "üå∏");
dictionaryBadWords.set("chaudasse", "üå∏");
dictionaryBadWords.set("chinetoque", "üå∏");
dictionaryBadWords.set("ching chong", "üå∏");
dictionaryBadWords.set("connard", "üå∏");
dictionaryBadWords.set("connasse", "üå∏");
dictionaryBadWords.set("crouille", "üå∏");
dictionaryBadWords.set("d√©bile", "üå∏");
dictionaryBadWords.set("donzelle", "üå∏");
dictionaryBadWords.set("encul√©", "üå∏");
dictionaryBadWords.set("enculer", "üå∏");
dictionaryBadWords.set("fais pas ta meuf", "üå∏");
dictionaryBadWords.set("fatma", "üå∏");
dictionaryBadWords.set("FDP", "üå∏");
dictionaryBadWords.set("fille de joie", "üå∏");
dictionaryBadWords.set("fille facile", "üå∏");
dictionaryBadWords.set("fille l√©g√®re", "üå∏");
dictionaryBadWords.set("fils de pute", "üå∏");
dictionaryBadWords.set("fils de putain", "üå∏");
dictionaryBadWords.set("fiotte", "üå∏");
dictionaryBadWords.set("garce", "üå∏");
dictionaryBadWords.set("gogole", "üå∏");
dictionaryBadWords.set("gonzesse", "üå∏");
dictionaryBadWords.set("gouine", "üå∏");
dictionaryBadWords.set("grognasse", "üå∏");
dictionaryBadWords.set("grosse vache", "üå∏");
dictionaryBadWords.set("hyst√©rique", "üå∏");
dictionaryBadWords.set("macaque", "üå∏");
dictionaryBadWords.set("mal-bais√©", "üå∏");
dictionaryBadWords.set("mal-bais√©e", "üå∏");
dictionaryBadWords.set("m√©g√®re", "üå∏");
dictionaryBadWords.set("n√®gre", "üå∏");
dictionaryBadWords.set("n√©gresse", "üå∏");
dictionaryBadWords.set("n√©gro", "üå∏");
dictionaryBadWords.set("niakou√©", "üå∏");
dictionaryBadWords.set("niakou√©e", "üå∏");
dictionaryBadWords.set("niaqu√©", "üå∏");
dictionaryBadWords.set("niaqu√©e", "üå∏");
dictionaryBadWords.set("niaquou√©", "üå∏");
dictionaryBadWords.set("niaquou√©e", "üå∏");
dictionaryBadWords.set("nigga", "üå∏");
dictionaryBadWords.set("nigger", "üå∏");
dictionaryBadWords.set("nique", "üå∏");
dictionaryBadWords.set("nique ta m√®re", "üå∏");
dictionaryBadWords.set("peau rouge", "üå∏");
dictionaryBadWords.set("p√©dale", "üå∏");
dictionaryBadWords.set("p√©d√©", "üå∏");
dictionaryBadWords.set("PD", "üå∏");
dictionaryBadWords.set("p√©tasse", "üå∏");
dictionaryBadWords.set("pimb√™che", "üå∏");
dictionaryBadWords.set("pouffiasse", "üå∏");
dictionaryBadWords.set("pouffiasse", "üå∏");
dictionaryBadWords.set("putain", "üå∏");
dictionaryBadWords.set("putasse", "üå∏");
dictionaryBadWords.set("pute", "üå∏");
dictionaryBadWords.set("racoleuse", "üå∏");
dictionaryBadWords.set("retourne dans ton pays", "üå∏");
dictionaryBadWords.set("sale arabe", "üå∏");
dictionaryBadWords.set("sale brid√©", "üå∏");
dictionaryBadWords.set("sale juif", "üå∏");
dictionaryBadWords.set("sale juive", "üå∏");
dictionaryBadWords.set("sale musulman", "üå∏");
dictionaryBadWords.set("sale musulmane", "üå∏");
dictionaryBadWords.set("sale noir", "üå∏");
dictionaryBadWords.set("sale trans", "üå∏");
dictionaryBadWords.set("salope", "üå∏");
dictionaryBadWords.set("singe noir", "üå∏");
dictionaryBadWords.set("tafiole", "üå∏");
dictionaryBadWords.set("tantouze", "üå∏");
dictionaryBadWords.set("tapette", "üå∏");
dictionaryBadWords.set("tapineuse", "üå∏");
dictionaryBadWords.set("tarlouse", "üå∏");
dictionaryBadWords.set("tchoin", "üå∏");
dictionaryBadWords.set("teub√©", "üå∏");
dictionaryBadWords.set("toubab", "üå∏");
dictionaryBadWords.set("train√©e", "üå∏");
dictionaryBadWords.set("travelo", "üå∏");
dictionaryBadWords.set("va manger du chien", "üå∏");
dictionaryBadWords.set("vieille-peau", "üå∏");
dictionaryBadWords.set("youpin", "üå∏");
dictionaryBadWords.set("youpine", "üå∏");

let regexBadWords = new Map();

//function that replaces letters with accents
String.prototype.sansAccents = function () {
  return this.replace(/[√π√ª√º]/g, "u")
    .replace(/[√Æ√Ø]/g, "i")
    .replace(/[√†√¢√§]/g, "a")
    .replace(/[√¥√∂]/g, "o")
    .replace(/[√©√®√™√´]/g, "e")
    .replace(/√ß/g, "c");
};

for (let element of dictionaryBadWords.keys()) {
  regexBadWords.set(
    element,
    new RegExp("\\b" + element.sansAccents() + "\\b", "gi")
  );
}

initialize();

function initialize() {
  console.log("üë∫ initialize emoji-map.js");
  var gettingAllStorageItems = browser.storage.local.get(null);
  gettingAllStorageItems.then((results) => {
    var wordsJSONstring = results[key];
    var wordsArray = Parse(wordsJSONstring);
    // var wordKeys = Object.keys(results);
    for (let word of wordsArray) {
      addToDictionary(word);
    }
  }, onError);
}

browser.runtime.onMessage.addListener(handleMessage);

replaceUserWordWithEmoji([]);

function replaceUserWordWithEmoji(words) {
  for (let word of words) {
    console.log("üëà word before " + word);
    console.log("üëà array before " + words);
    addToDictionary(word);
    console.log("üëâ word after " + word);
    console.log("üëâ array after " + words);
  }
  replaceText(document.body);
}

function handleMessage(request) {
  console.log("‚ùì");
  console.log(" ‚ö†Ô∏è Message from the content script: " + request.word);
  var wordsArray = JSON.parse(request.word);
  console.log("array : " + wordsArray);
  replaceUserWordWithEmoji(wordsArray);
  // sendResponse({ response: "Response from background script" });
}

//gets active tab
function getActiveTab() {
  return browser.tabs.query({ active: true, currentWindow: true });
}

// The user can add new words to dictionnary

function addToDictionary(word) {
  if (word) {
    dictionaryBadWords.set(word, "üå∏");
    try {
      regexBadWords.set(word, new RegExp("\\b" + word + "\\b", "gi"));
    } catch (error) {
      console.log("addToDictionary failed : " + error);
    }
  }
}

//Replace Text

function replaceText(node) {
  if (node.nodeType === Node.TEXT_NODE) {
    if (node.parentNode && node.parentNode.nodeName === "TEXTAREA") {
      return;
    }

    let content = node.textContent;
    for (let [element, emoji] of dictionaryBadWords) {
      let regex = regexBadWords.get(element);

      if (!document.getElementById("badWordsList")) {
        content = content.sansAccents().replace(regex, emoji);
      }
    }

    node.textContent = content;
  } else {
    for (let i = 0; i < node.childNodes.length; i++) {
      replaceText(node.childNodes[i]);
    }
  }
}

replaceText(document.body);

// Replaces text if modification of the DOM

const observer = new MutationObserver((mutations) => {
  mutations.forEach((mutation) => {
    if (mutation.addedNodes && mutation.addedNodes.length > 0) {
      for (let i = 0; i < mutation.addedNodes.length; i++) {
        const newNode = mutation.addedNodes[i];
        replaceText(newNode);
      }
    }
  });
});
observer.observe(document.body, {
  childList: true,
  subtree: true,
});
